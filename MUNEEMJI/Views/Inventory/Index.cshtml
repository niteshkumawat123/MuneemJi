<!-- Views/Inventory/Index.cshtml -->
@{
    Layout = "~/Views/Shared/_Layout.cshtml"; // Or use a shared layout if available
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Inventory Management</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* Optional: custom styles to better match screenshot spacing */
        .nav-tabs .nav-link {
            font-weight: bold;
        }

        .table-hover tbody tr:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }

        .table-active {
            background-color: #e0f7fa;
        }
        /* highlight selected row */
        .tab-content {
            margin-top: 15px;
        }

        .sidebar-panel {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h3 class="mt-3">Inventory</h3>
        <!-- Tab navigation -->
        <ul class="nav nav-tabs" id="inventoryTabs">
            <li class="nav-item">
                <a class="nav-link active" id="products-tab" data-tab="Products" href="#">Products</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="services-tab" data-tab="Services" href="#">Services</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="category-tab" data-tab="Category" href="#">Category</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="units-tab" data-tab="Units" href="#">Units</a>
            </li>
        </ul>

        <!-- Content container -->
        <div id="tabContent" class="tab-content p-3 border border-top-0">
            <!-- Initial content will be loaded via AJAX -->
        </div>
    </div>
    </body>
    <!-- jQuery and Bootstrap JS (via CDN) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function () {
            // Load the initial Products tab content on page load
            loadTab('Products');

            // Tab click handler
            $('#inventoryTabs a.nav-link').on('click', function (e) {
                e.preventDefault();
                var tab = $(this).data('tab');
                $('#inventoryTabs a.nav-link').removeClass('active');
                $(this).addClass('active');
                loadTab(tab);
            });
        });

        // Function to load a tab's partial view via AJAX
        function loadTab(tabName) {
            $.get('/Inventory/' + tabName, function (data) {
                $('#tabContent').html(data);

                // Initialize UI behaviors for each tab after loading
                if (tabName === 'Products') initProductsTab();
                else if (tabName === 'Services') initServicesTab();
                else if (tabName === 'Category') initCategoryTab();
                else if (tabName === 'Units') initUnitsTab();
            });
        }

        // Global variables to track selections
        var selectedProductId = null;
        var selectedCategoryId = null;
        var selectedUnitId = null;

        // Initialize Products tab after loading
        function initProductsTab() {
            // Highlight and load first product by default
            var $firstRow = $('.product-row').first();
            if ($firstRow.length) {
                $firstRow.addClass('table-active');
                selectedProductId = $firstRow.data('id');
                loadProductDetails(selectedProductId);
            }

            // Click on a product row to select it
            $('.product-row').on('click', function () {
                $('.product-row').removeClass('table-active');
                $(this).addClass('table-active');
                selectedProductId = $(this).data('id');
                loadProductDetails(selectedProductId);
            });

            // Add Item button click
            $('#btnAddProduct').on('click', function () {
                //clearProductForm();
                //$('#productModal').data('id', null).modal('show');
            window.location.href = "/items/create";
            });

            // Delete product
            $('.delete-product').on('click', function (e) {
                e.stopPropagation();
                var prodId = $(this).data('id');
                if (confirm('Delete this item?')) {
                    $.post('/Products/Delete', { id: prodId }, function () {
                        loadTab('Products');
                    });
                }
            });

            // Edit product
            $('#btnEditProduct').on('click', function () {
                if (selectedProductId) {
                    // Load product details into form
                    $.getJSON('/Products/Get/' + selectedProductId, function (prod) {
                        $('#productModal input[name="Name"]').val(prod.Name);
                        $('#productModal input[name="SalePrice"]').val(prod.SalePrice);
                        $('#productModal input[name="PurchasePrice"]').val(prod.PurchasePrice);
                        $('#productModal input[name="Quantity"]').val(prod.Quantity);
                        $('#productModal').data('id', prod.Id).modal('show');
                    });
                } else {
                    alert('Select an item first.');
                }
            });

            // Save (Add or Update) product
            $('#btnSaveProduct').on('click', function () {
                var id = $('#productModal').data('id');
                var formData = {
                    Name: $('#productModal input[name="Name"]').val(),
                    SalePrice: $('#productModal input[name="SalePrice"]').val(),
                    PurchasePrice: $('#productModal input[name="PurchasePrice"]').val(),
                    Quantity: $('#productModal input[name="Quantity"]').val()
                };
                if (id) {
                    formData.Id = id;
                    $.post('/Products/Update', formData, function () {
                        $('#productModal').modal('hide');
                        loadTab('Products');
                    });
                } else {
                    $.post('/Products/Add', formData, function () {
                        $('#productModal').modal('hide');
                        loadTab('Products');
                    });
                }
            });
        }

        // Load product details into the right panel
        function loadProductDetails(id) {
            $.getJSON('/Products/Get/' + id, function (prod) {
                $('#detailName').text(prod.Name);
                $('#detailSalePrice').text('₹ ' + prod.SalePrice.toFixed(2));
                $('#detailPurchasePrice').text('₹ ' + prod.PurchasePrice.toFixed(2));
                $('#detailQuantity').text(prod.Quantity);
                var stockValue = prod.Quantity > 0 ? (prod.Quantity * prod.PurchasePrice) : 0;
                $('#detailStockValue').text('₹ ' + stockValue.toFixed(2));
            });
        }

        // Clear the product form fields
        function clearProductForm() {
            $('#productModal input').val('');
        }

        // Initialize Services tab after loading
        function initServicesTab() {
            // If there are services, do nothing special
            // If none, the partial shows empty state already

            // Add Service button click
            $('#btnAddService, #btnAddFirstService').on('click', function () {
                // $('#serviceModal input').val('');
                // $('#serviceModal').data('id', null).modal('show');
            window.location.href = "/items/create";
            });

            // Edit and Delete buttons
            $('.edit-service').on('click', function () {
                var servId = $(this).data('id');
                // Load service details into form (if implementing edit; not shown in UI)
                // For simplicity, skip editing details retrieval
                var name = $(this).closest('tr').find('.service-name').text();
                var price = $(this).closest('tr').find('.service-price').text();
                $('#serviceModal input[name="Name"]').val(name);
                $('#serviceModal input[name="Price"]').val(price);
                $('#serviceModal').data('id', servId).modal('show');
            });
            $('.delete-service').on('click', function () {
                var servId = $(this).data('id');
                if (confirm('Delete this service?')) {
                    $.post('/Services/Delete', { id: servId }, function () {
                        loadTab('Services');
                    });
                }
            });

            // Save Service (Add or Update)
            $('#btnSaveService').on('click', function () {
                // var id = $('#serviceModal').data('id');
                // var formData = {
                //     Name: $('#serviceModal input[name="Name"]').val(),
                //     Price: $('#serviceModal input[name="Price"]').val()
                // };
                // if (id) {
                //     formData.Id = id;
                //     $.post('/Services/Update', formData, function () {
                //         $('#serviceModal').modal('hide');
                //         loadTab('Services');
                //     });
                // } else {
                //     $.post('/Services/Add', formData, function () {
                //         $('#serviceModal').modal('hide');
                //         loadTab('Services');
                //     });
                // }
            window.location.href = "/items/create";
            });
        }

        // Initialize Category tab after loading
        function initCategoryTab() {
            // Set global selectedCategoryId
            selectedCategoryId = parseInt($('#categoryTab').data('selectedcategory'));

            // Highlight first category if none selected
            var $firstCat = $('.category-row').first();
            if ($firstCat.length) {
                $('.category-row').removeClass('table-active');
                $firstCat.addClass('table-active');
                selectedCategoryId = $firstCat.data('id');
            }

            // Category row click
            $('.category-row').on('click', function () {
                $('.category-row').removeClass('table-active');
                $(this).addClass('table-active');
                var id = $(this).data('id');
                selectedCategoryId = id;
                loadTab('Category?id=' + id);
            });

            // Add Category button
            $('#btnAddCategory').on('click', function () {
                $('#categoryModal input').val('');
                $('#categoryModal').modal('show');
            });
            $('#btnSaveCategory').on('click', function () {
                var name = $('#categoryModal input[name="Name"]').val();
                $.post('/Category/Add', { name: name }, function () {
                    $('#categoryModal').modal('hide');
                    loadTab('Category');
                });
            });

            // Item row click to select a product in category
            $('.category-item-row').on('click', function () {
                $('.category-item-row').removeClass('table-active');
                $(this).addClass('table-active');
            });

            // Move To This Category button
            $('#btnMoveToCategory').on('click', function () {
                var $selectedItem = $('.category-item-row.table-active');
                if (!$selectedItem.length) {
                    alert('Select an item to move.');
                    return;
                }
                var prodId = $selectedItem.data('id');
                $.post('/Category/MoveProduct', { productId: prodId, categoryId: selectedCategoryId }, function () {
                    loadTab('Category?id=' + selectedCategoryId);
                });
            });
        }

        // Initialize Units tab after loading
        function initUnitsTab() {
            // Set global selectedUnitId
            selectedUnitId = parseInt($('#unitsTab').data('selectedunit'));
            // Highlight first unit if none selected
            var $firstUnit = $('.unit-row').first();
            if ($firstUnit.length) {
                $('.unit-row').removeClass('table-active');
                $firstUnit.addClass('table-active');
                selectedUnitId = $firstUnit.data('id');
            }

            // Unit row click
            $('.unit-row').on('click', function () {
                $('.unit-row').removeClass('table-active');
                $(this).addClass('table-active');
                selectedUnitId = $(this).data('id');
                loadTab('Units?id=' + selectedUnitId);
            });

            // Add Unit button
            $('#btnAddUnit').on('click', function () {
                $('#unitModal input').val('');
                $('#unitModal').modal('show');
            });
            $('#btnSaveUnit').on('click', function () {
                var formData = {
                    FullName: $('#unitModal input[name="FullName"]').val(),
                    ShortName: $('#unitModal input[name="ShortName"]').val()
                };
                $.post('/Units/AddUnit', formData, function () {
                    $('#unitModal').modal('hide');
                    loadTab('Units');
                });
            });

            // Delete Unit buttons
            $('.delete-unit').on('click', function (e) {
                e.stopPropagation();
                var unitId = $(this).data('id');
                if (confirm('Delete this unit?')) {
                    $.post('/Units/DeleteUnit', { id: unitId }, function () {
                        loadTab('Units');
                    });
                }
            });

            // Add Conversion button
            $('#btnAddConversion').on('click', function () {
                // Populate dropdown of other units
                var $toUnit = $('#conversionModal select[name="ToUnitId"]');
                $toUnit.empty();
                $('#unitsTab select[name="Units"] option').each(function () {
                    var id = parseInt($(this).val());
                    var name = $(this).text();
                    if (id !== selectedUnitId) {
                        $toUnit.append($('<option>').val(id).text(name));
                    }
                });
                $('#conversionModal input[name="Factor"]').val('');
                $('#conversionModal').modal('show');
            });
            $('#btnSaveConversion').on('click', function () {
                var toId = $('#conversionModal select[name="ToUnitId"]').val();
                var factor = $('#conversionModal input[name="Factor"]').val();
                $.post('/Units/AddConversion', { fromUnitId: selectedUnitId, toUnitId: toId, factor: factor }, function () {
                    $('#conversionModal').modal('hide');
                    loadTab('Units?id=' + selectedUnitId);
                });
            });

            // Delete Conversion button
            $('.delete-conv').on('click', function () {
                var convId = $(this).data('id');
                if (confirm('Delete this conversion?')) {
                    $.post('/Units/DeleteConversion', { id: convId }, function () {
                        loadTab('Units?id=' + selectedUnitId);
                    });
                }
            });
        }
    </script>
